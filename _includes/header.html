<header
  id="site-header"
>
  <script>
    // Check localStorage immediately to prevent flash of expanded menu
    (function() {
      var header = document.getElementById('site-header');
      var menuContents = document.getElementById('menu-contents');
      var mainContent = document.getElementById('main-content');
      var isCollapsed = localStorage.getItem('menuCollapsed') === 'true';
      
      // Only apply collapsed state if not on mobile
      if (isCollapsed && window.innerWidth >= 768) {
        header.classList.add('collapsed');
        if (menuContents) {
          menuContents.classList.add('hidden');
        }
        if (mainContent) {
          mainContent.classList.add('menu-collapsed');
        }
      }
    })();
  </script>

  
  <div id="expand-button-container" class="md:flex flex-col" style="display: none;">

    <div class="collapsed-logomark flex justify-center border-b border-white/25 w-full text-center">
      <a href="/" class="text-white/75 inline-block px-1 pt-2 pb-1.5">{% include icon-eagle.html %}</a>
    </div>
    
    <button id="expand-button" class="flex justify-center px-1 py-1.5 m-0 min-w-0 items-center gap-1 text-sm !text-opacity-75 hover:!text-opacity-100 !text-white" aria-label="Expand menu" aria-expanded="false">
      <span class="size-5">{% include icon-menu.html %}</span>
    </button>
  </div>

  <div id="menu-contents" class="flex flex-col gap-4 flex-1 p-2">
    <div class="flex-[0_0_auto] flex md:flex-col gap-2 items-center">
      
      <div class="flex-1">
        <a href="/" class="md:hidden">
          <img src="/assets/images/logo-horizontal.png" alt="DataRepublican" class="max-w-[240px] h-auto" alt="DataRepublican" />
        </a>    
        <a href="/" class="hidden md:block">
          <img src="/assets/images/logo-vertical.png" alt="DataRepublican" class="max-w-[220px] h-auto mx-auto" alt="DataRepublican" />
        </a>
      </div>

      <button id="mobile-menu-button" class="md:hidden px-2 py-1.5 rounded bg-transparent border-2 border-white/50 flex items-center gap-1 font-semibold text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path class="menu-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          <path class="close-icon hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span class="menu-text">Menu</span>
      </button>
    </div>
    <div id="menu-items" class="hidden p-4 md:p-0 md:visible md:flex flex-1 flex-col justify-between md:gap-1 sm:gap-2 fixed md:static right-0 w-full md:w-auto md:h-auto bg-navy z-50 transition-transform duration-300 translate-x-full md:translate-x-0">
      <div class="flex-1 flex flex-col gap-px">

        <div class="flex flex-col gap-0.5">
          <button 
            id="charity-funding-dropdown-button"
            class="nav-dropdown-button flex flex-col text-white no-underline py-1 px-3 rounded focus:outline focus:outline-2 focus:outline-blue focus:outline-offset-2 border-2 bg-transparent mr-0 {% if page.url contains '/expose' or page.url contains '/nonprofit' %}is-active border-transparent{% else %}border-transparent hover:border-white/75 hover:bg-white/10 opacity-75 hover:opacity-100{% endif %} relative group justify-start items-start transition-opacity"
          >
            <strong class="text-base md:text-sm w-full md:w-auto text-left">Charity funding &amp; financials</strong>
            <span class="opacity-70 font-normal text-sm md:text-[13px] w-full md:w-auto text-left">Track money flow and spending</span>
            <span class="absolute top-[calc(50%-.625rem)] right-2 size-5 opacity-50 group-hover:opacity-100 transition-transform rotate-90">
              {% include icon-chevron.html %}
            </span>
          </button>
          
          <div 
            id="charity-funding-dropdown"
            class="nav-dropdown-content relative pl-2 overflow-hidden transition-all duration-300 flex flex-col gap-0.5"
          >
            {% include nav-link.html 
              title="Charity graph"
              subtitle="Visualize how the money flows"
              url="/expose"
              classes=""
            %}
            {% include nav-link.html 
              title="Charity funding"
              subtitle="Discover % of taxpayer funds used"
              url="/nonprofit"
              classes=""
            %}
            {% include nav-link.html 
              title="Nonprofit financials"
              subtitle="Analyze expenses & assets"
              url="/nonprofit/assets"
              classes=""
              new="true"
            %}
          </div>
        </div>
        {% include nav-link.html
          title="People relations"
          subtitle="Explore people connections"
          url="/relations"
          classes=""
          label="Beta"
        %}

        <div class="flex flex-col gap-0.5">
          <button 
            id="officers-dropdown-button"
            class="nav-dropdown-button flex flex-col text-white no-underline py-1 px-3 rounded focus:outline focus:outline-2 focus:outline-blue focus:outline-offset-2 border-2 bg-transparent mr-0 {% if page.url contains '/officers' %}is-active border-transparent{% else %}border-transparent hover:border-white/75 hover:bg-white/10{% endif %} relative group justify-start items-start"
          >
            <strong class="text-base md:text-sm w-full md:w-auto text-left">Officers &amp; salaries</strong>
            <span class="opacity-70 font-normal text-sm md:text-[13px] w-full md:w-auto text-left">Search NGO officers and salaries</span>
            <span class="absolute top-[calc(50%-.625rem)] right-2 size-5 opacity-50 group-hover:opacity-100 transition-transform rotate-90">
              {% include icon-chevron.html %}
            </span>
          </button>
          
          <div 
            id="officers-dropdown"
            class="nav-dropdown-content relative pl-2 overflow-hidden transition-all duration-300 flex flex-col gap-0.5"
          >
            {% include nav-link.html 
              title="Principal officer search"
              subtitle="Explore for NGO officers and salaries"
              url="/officers"
              classes=""
            %}
            {% include nav-link.html 
              title="Bulk NGO officer search"
              subtitle="Search and cross-reference names"
              url="/officers/bulk"
              classes=""
              new="true"
            %}
          </div>
        </div>

        <div class="flex flex-col gap-0.5">
          <button 
            id="political-funding-dropdown-button"
            class="nav-dropdown-button flex flex-col text-white no-underline py-1 px-3 rounded focus:outline focus:outline-2 focus:outline-blue focus:outline-offset-2 border-2 bg-transparent mr-0 {% if page.url contains '/donations2024' or page.url contains '/award_search' %}is-active border-transparent{% else %}border-transparent hover:border-white/75 hover:bg-white/10{% endif %} relative group justify-start items-start"
          >
            <strong class="text-base md:text-sm w-full md:w-auto text-left">Political campaign &amp; grant funding</strong>
            <span class="opacity-70 font-normal text-sm md:text-[13px] w-full md:w-auto text-left">Donations and taxpayer-funded grants</span>
            <span class="absolute top-[calc(50%-.625rem)] right-2 size-5 opacity-50 group-hover:opacity-100 transition-transform rotate-90">
              {% include icon-chevron.html %}
            </span>
          </button>
          
          <div 
            id="political-funding-dropdown"
            class="nav-dropdown-content relative pl-2 overflow-hidden transition-all duration-300 flex flex-col gap-0.5"
          >
            {% include nav-link.html 
              title="Small dollar donations"
              subtitle="ActBlue & WinRed donations"
              url="/donations2024"
              classes=""
              new="true"
            %}
            {% include nav-link.html 
              title="Federal grant search"
              subtitle="Map funds to connected orgs"
              url="/award_search"
              classes=""
            %}
          </div>
        </div>

      <button 
        id="election-results-dropdown-button"
        class="nav-dropdown-button flex flex-col text-white no-underline py-1 px-3 rounded focus:outline focus:outline-2 focus:outline-blue focus:outline-offset-2 border-2 bg-transparent mr-0 {% if page.url contains '/florida' or page.url contains '/northcarolina' or page.url contains '/pennsylvania' %}is-active border-transparent{% else %}border-transparent hover:border-white/75 hover:bg-white/10{% endif %} relative group justify-start items-start"
        {% if include.target %}target="{{ include.target }}"{% endif %}
      >
        <strong class="text-base md:text-sm w-full md:w-auto text-left">Voter turnout analysis</strong>
        <span class="opacity-70 font-normal text-sm md:text-[13px] w-full md:w-auto text-left">2024 vs. previous elections</span>
        <span class="absolute top-[calc(50%-.625rem)] right-2 size-5 opacity-50 group-hover:opacity-100 transition-transform rotate-90">
          {% include icon-chevron.html %}
        </span>
      </button> 

      <div 
        id="election-results-dropdown"
        class="nav-dropdown-content relative pl-2 overflow-hidden transition-all duration-300 flex flex-col gap-0.5"
      >
        {% include nav-link.html 
          title="Florida"
          url="/florida"
          classes=""
          icon="fl"
        %}
        {% include nav-link.html 
          title="North Carolina"
          url="/northcarolina"
          classes=""
          icon="nc"
        %}
        {% include nav-link.html 
          title="Pennsylvania"
          url="/pennsylvania"
          classes=""
          icon="pa"
        %}
      </div>
    </div>
    <div class="flex flex-col gap-0.5">
      {% include nav-link.html 
        title="Donate"
        subtitle="Help support our work"
        url="/donate"
        classes="!border-green-light bg-green-light/20 hover:!bg-green-light hover:text-navy relative [&_.right-icon]:text-green-light"
        right-icon="gift"
      %}
      {% include nav-link.html 
        title="Follow on X"
        subtitle="@datarepublican"
        url="https://x.com/datarepublican"
        target="_blank"
        classes="relative "
        right-icon="twitter"
      %}
      {% include nav-link.html 
        title="The historical case for Christianity"
        url="/christianity"
      %}
    </div>
      

    </div>
  </div>
    <div class="border-t border-white/25 hover:border-white/50 hidden md:block">
    <button id="collapse-button" class="frameless flex items-center gap-1 text-sm !text-opacity-75 hover:!text-opacity-100 !text-white !p-2 !pr-4 justify-center w-full" aria-label="Collapse menu" aria-expanded="true">
      <span class="size-4">{% include icon-collapse.html %}</span>
      Collapse menu
    </button>
    <button id="expand-button" class="frameless flex items-center gap-1 text-sm !text-opacity-75 hover:!text-opacity-100 !text-white hidden" aria-label="Expand menu" aria-expanded="false">
      <span class="size-4">{% include icon-menu.html %}</span>
    </button>
  </div>
</header>

<script>
  $(document).ready(function() {
    const $menuButton = $('#mobile-menu-button');
    const $menuItems = $('#menu-items');
    const $header = $('header');
    const $menuIcon = $menuButton.find('.menu-icon');
    const $closeIcon = $menuButton.find('.close-icon');
    const $menuText = $menuButton.find('.menu-text');
    
    // New elements for collapse/expand functionality
    const $collapseButton = $('#collapse-button');
    const $expandButton = $('#expand-button');
    const $expandButtonContainer = $('#expand-button-container');
    const $menuContents = $('#menu-contents');
    const $mainContent = $('body > div');
    
    // Check if the header is already collapsed from the inline script
    const isInitiallyCollapsed = $header.hasClass('collapsed');
    
    // Set initial state of buttons and menu contents based on header state
    if (isInitiallyCollapsed && window.innerWidth >= 768) {
      $menuContents.addClass('hidden');
      $collapseButton.addClass('hidden');
      $expandButtonContainer.addClass('md:flex');
      $expandButtonContainer.removeAttr('style');
      $mainContent.addClass('menu-collapsed');
    } else {
      $expandButtonContainer.addClass('hidden');
      
      // If on mobile, ensure menu is expanded regardless of localStorage
      if (window.innerWidth < 768) {
        $header.removeClass('collapsed');
        $menuContents.removeClass('hidden');
        $mainContent.removeClass('menu-collapsed');
      }
    }
    
    // Function to handle dropdown menus
    function setupDropdowns() {
      const $dropdownButtons = $('.nav-dropdown-button');
      const hasActiveButton = $dropdownButtons.hasClass('is-active');
      
      // If no active buttons, show all at full opacity
      if (!hasActiveButton) {
        $dropdownButtons.removeClass('opacity-75').addClass('opacity-100');
      } else {
        // Otherwise, set non-active buttons to reduced opacity
        $('.nav-dropdown-button:not(.is-active)').addClass('opacity-75 hover:opacity-100');
      }
      
      $dropdownButtons.each(function() {
        const $button = $(this);
        const $content = $('#' + $button.attr('id').replace('-button', ''));
        const $chevron = $button.find('span:last-child');
        
        // Make sure content exists before trying to manipulate it
        if ($content.length === 0) {
          console.warn('Dropdown content not found for button:', $button.attr('id'));
          return;
        }
        
        // Check if we're on a page that should have this dropdown expanded
        const isActive = $button.hasClass('is-active');
        
        // Set initial state
        if (isActive) {
          $content.addClass('expanded');
          $chevron.toggleClass('rotate-90 -rotate-90');
          $button.removeClass('opacity-75').addClass('opacity-100');
        } else {
          $content.removeClass('expanded');
        }
        
        // Add click event
        $button.on('click', function(e) {
          e.preventDefault();
          const isExpanded = $content.hasClass('expanded');
          
          // Toggle the dropdown
          if (isExpanded) {
            $content.removeClass('expanded');
          } else {
            $content.addClass('expanded');
          }
          
          // Toggle the chevron rotation classes
          $chevron.toggleClass('rotate-90 -rotate-90');
          
          // Toggle opacity class based on expanded state
          if (isExpanded) {
            // Only add opacity if there's an active button somewhere
            if (hasActiveButton) {
              $button.addClass('opacity-75 hover:opacity-100');
            }
          } else {
            $button.removeClass('opacity-75').addClass('opacity-100');
          }
        });
      });
    }
    
    // Initialize dropdowns
    setupDropdowns();

    // Function to update menu position and height
    function updateMenuPosition() {
      const headerHeight = $header.outerHeight();
      document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
      
      if (window.innerWidth < 768) { // Only set these on mobile
        $menuItems
          .css('height', `calc(100vh - ${headerHeight}px)`);
      } else {
        // Reset styles on desktop
        $menuItems
          .css('height', '');
      }
    }
    
    // Update position initially and on resize
    updateMenuPosition();
    $(window).on('resize', updateMenuPosition);

    function showMenu() {
      $menuItems
        .css('display', 'flex')
        .removeClass('hidden');
      
      // Use a small timeout to ensure the display:flex is applied before adding the class
      setTimeout(function() {
        $menuItems.addClass('menu-visible').removeClass('translate-x-full');
      }, 10);
      
      // Update button to show close state
      $menuIcon.addClass('hidden');
      $closeIcon.removeClass('hidden');
      $menuText.text('Close');
    }

    function hideMenu() {
      $menuItems
        .removeClass('menu-visible')
        .one('transitionend', function(e) {
          if (window.innerWidth < 768) {
            $(this).addClass('hidden').css('display', '');
          }
        });
      
      // Update button to show menu state
      $menuIcon.removeClass('hidden');
      $closeIcon.addClass('hidden');
      $menuText.text('Menu');
    }

    // Event listeners for mobile menu
    $menuButton.on('click', function() {
      if ($menuItems.hasClass('hidden')) {
        showMenu();
      } else {
        hideMenu();
      }
    });
    
    // Functions for collapse/expand functionality
    function collapseMenu() {
      // Only apply on desktop
      if (window.innerWidth >= 768) {
        $header.addClass('collapsed');
        $menuContents.addClass('hidden');
        $collapseButton.addClass('hidden');
        $expandButtonContainer.removeClass('!hidden');
        $mainContent.removeClass('menu-expanded');
        $mainContent.addClass('menu-collapsed');
        localStorage.setItem('menuCollapsed', 'true');
        $collapseButton.attr('aria-expanded', 'false');
        $expandButton.attr('aria-expanded', 'true');
        $expandButtonContainer.removeAttr('style');

      }
    }
    
    function expandMenu() {
      $header.removeClass('collapsed');
      $menuContents.removeClass('hidden');
      $collapseButton.removeClass('hidden');
      $expandButtonContainer.addClass('!hidden');
      $mainContent.removeClass('menu-collapsed');
      $mainContent.addClass('menu-expanded');
      localStorage.setItem('menuCollapsed', 'false');
      $collapseButton.attr('aria-expanded', 'true');
      $expandButton.attr('aria-expanded', 'false');
    }
    
    // Set localStorage default if needed
    if (localStorage.getItem('menuCollapsed') === null) {
      localStorage.setItem('menuCollapsed', 'false');
    }
    
    // Event listeners for collapse/expand
    $collapseButton.on('click', collapseMenu);
    $expandButton.on('click', expandMenu);
    
    // Handle window resize to ensure proper state on breakpoint changes
    $(window).on('resize', function() {
      if (window.innerWidth < 768) {
        // On mobile, always show expanded menu
        $header.removeClass('collapsed');
        $menuContents.removeClass('hidden');
        $mainContent.removeClass('menu-collapsed');
      } else {
        // On desktop, respect the localStorage setting
        const shouldBeCollapsed = localStorage.getItem('menuCollapsed') === 'true';
        if (shouldBeCollapsed) {
          $header.addClass('collapsed');
          $menuContents.addClass('hidden');
          $collapseButton.addClass('hidden');
          $expandButton.removeClass('hidden');
          $mainContent.addClass('menu-collapsed');
        } else {
          $header.removeClass('collapsed');
          $menuContents.removeClass('hidden');
          $collapseButton.removeClass('hidden');
          $expandButton.addClass('hidden');
          $mainContent.removeClass('menu-collapsed');
        }
      }
    });
  });
</script>

<style>
  /* Add this style to your header.html or in your CSS file */
  .nav-dropdown-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  
  .nav-dropdown-content.expanded {
    max-height: 500px; /* Set this to a value larger than your tallest dropdown */
  }
  
  /* Mobile menu animation styles */
  @media (max-width: 767px) {
    #menu-items {
      transform: translateY(100%);
      transition: transform 0.3s ease;
      right: 0;
      left: 0;
      bottom: 0;
      top: auto;
      height: calc(100vh - var(--header-height, 60px));
      overflow-y: auto;
    }
    
    #menu-items.menu-visible {
      transform: translateY(0);
    }
  }
  
  /* Keep the existing horizontal slide for desktop */
  @media (min-width: 768px) {
    #menu-items {
      transform: none !important;
      top: auto;
      bottom: auto;
      height: auto;
      overflow-y: visible;
    }
  }
</style>



